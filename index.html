<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>AgriTerra Land Scout - Ohio Edition</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WP97VS7YGP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-WP97VS7YGP');
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <style>
        /* FIX: Touch-friendly Drawing Tools without breaking icons */
        .leaflet-draw-section {
            margin-top: 10px !important;
            margin-left: 10px !important;
        }

        .leaflet-draw-toolbar a {
            width: 44px !important;
            height: 44px !important;
            background-color: white !important;
            background-size: 270px 30px !important; /* Adjusts the sprite scale to match new size */
            border-bottom: 1px solid #ccc !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        /* Adjusting the specific background positions for the larger buttons */
        .leaflet-draw-draw-polygon { background-position: -27px -1px !important; }
        .leaflet-draw-draw-rectangle { background-position: -58px -1px !important; }
        .leaflet-draw-edit-edit { background-position: -145px -1px !important; }
        .leaflet-draw-edit-remove { background-position: -175px -1px !important; }

        /* Mobile vs Desktop Layout Logic */
        #sidebar { 
            width: 100%; max-height: 45vh; background: #f8f9fa; 
            box-shadow: 0 -4px 15px rgba(0,0,0,0.15); z-index: 1000; 
            overflow-y: auto; padding: 20px; box-sizing: border-box;
            border-top-left-radius: 15px; border-top-right-radius: 15px;
        }

        @media (min-width: 768px) {
            body { flex-direction: row; }
            #sidebar { 
                width: 380px; max-height: 100vh; height: 100%; 
                border-radius: 0; box-shadow: 2px 0 10px rgba(0,0,0,0.1); 
            }
            #map { height: 100%; }
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="sidebar">
        <h1><span class="brand">AgriTerra</span> Scout <span class="badge">OHIO</span></h1>
        
        <div class="search-container">
            <input type="text" id="addressInput" placeholder="Address or Zip Code..." />
            <button id="searchBtn">Find</button>
        </div>

        <button id="analyzeBtn" class="btn" disabled>Generate Report</button>
        
        <div id="loading" class="loading">Analyzing Ohio parcel...</div>
        <div id="results"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <script>
        // 1. Map Setup
        var ohioBounds = [[38.401, -84.820], [41.977, -80.518]];
        var streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' });
        var satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });

        var map = L.map('map', { 
            center: [40.417, -82.907], zoom: 7, 
            maxBounds: ohioBounds, layers: [satelliteMap], zoomControl: false 
        });
        
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.control.layers({ "Satellite": satelliteMap, "Street": streetMap }, {}, { position: 'topright' }).addTo(map);

        // Geocoding
        document.getElementById('searchBtn').addEventListener('click', async () => {
            const query = document.getElementById('addressInput').value;
            if (!query) return;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Ohio')}`);
                const data = await res.json();
                if (data && data.length > 0) map.flyTo([data[0].lat, data[0].lon], 18);
            } catch (e) { console.error(e); }
        });

        // Drawing
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        var drawControl = new L.Control.Draw({ 
            position: 'topleft', 
            draw: { polygon: { shapeOptions: { color: '#27ae60' } }, rectangle: { shapeOptions: { color: '#27ae60' } }, marker: false, circle: false, circlemarker: false, polyline: false }, 
            edit: { featureGroup: drawnItems, remove: true }
        });
        map.addControl(drawControl);

        let currentLayer = null;
        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.clearLayers();
            currentLayer = e.layer;
            drawnItems.addLayer(currentLayer);
            document.getElementById('analyzeBtn').disabled = false;
        });

        // Analysis
        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            if (!currentLayer) return;
            const resDiv = document.getElementById('results');
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            resDiv.innerHTML = '';
            
            const center = currentLayer.getBounds().getCenter();
            const acres = (turf.area(currentLayer.toGeoJSON()) * 0.000247105).toFixed(1);

            try {
                // Solar API (Replace Key!)
                const solarRes = await fetch(`https://developer.nrel.gov/api/pvwatts/v8.json?api_key=PLVvOusL7wjyAy2ZMcd0MFroNaL8sGI3hguxkHkm&lat=${center.lat}&lon=${center.lng}&system_capacity=4&azimuth=180&tilt=20&array_type=1&module_type=0&losses=14`);
                const solarData = await solarRes.json();
                const solarOutput = solarData.outputs ? Math.round(solarData.outputs.ac_annual) : "N/A";

                resDiv.innerHTML = `
                    <div class="report-card">
                        <div class="metric-title">Measured Parcel</div>
                        <div class="metric-value">${acres} <small>Acres</small></div>
                    </div>
                    <div class="report-card card-solar">
                        <div class="metric-title">Solar Potential</div>
                        <div class="metric-value">${solarOutput.toLocaleString()} <small>kWh/yr</small></div>
                    </div>

                    <div class="premium-header">Unlock Deep Analysis</div>
                    <div class="premium-grid">
                        <a href="insights.html?topic=property&acres=${acres}&lat=${center.lat}&lng=${center.lng}" target="_blank" class="premium-box">Property Info</a>
                        <a href="insights.html?topic=physical&acres=${acres}&lat=${center.lat}&lng=${center.lng}" target="_blank" class="premium-box">Soil Stats</a>
                        <a href="insights.html?topic=regulatory&acres=${acres}&lat=${center.lat}&lng=${center.lng}" target="_blank" class="premium-box">Regulatory</a>
                        <a href="insights.html?topic=infrastructure&acres=${acres}&lat=${center.lat}&lng=${center.lng}" target="_blank" class="premium-box">Infrastructure</a>
                        <a href="insights.html?topic=ag_value&acres=${acres}&lat=${center.lat}&lng=${center.lng}" target="_blank" class="premium-box">Ag Value</a>
                        <a href="insights.html?topic=market&acres=${acres}&lat=${center.lat}&lng=${center.lng}" target="_blank" class="premium-box">Market Context</a>
                        <a href="insights.html?topic=risks&acres=${acres}&lat=${center.lat}&lng=${center.lng}" target="_blank" class="premium-box">Risks/Trades</a>
                        <a href="insights.html?topic=insights&acres=${acres}&lat=${center.lat}&lng=${center.lng}" target="_blank" class="premium-box">Plain Insights</a>
                    </div>
                `;
            } catch (err) { resDiv.innerHTML = "Error loading analysis."; }
            finally { loading.style.display = 'none'; }
        });
    </script>
</body>
</html>

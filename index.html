<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriTerra Land Scout - Ohio Edition</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; height: 100vh; }
        #sidebar { width: 350px; background: #f8f9fa; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 1000; overflow-y: auto; }
        #map { flex-grow: 1; }
        
        h1 { color: #2c3e50; font-size: 1.5rem; margin-top: 0; }
        .brand { color: #27ae60; font-weight: bold; }
        .badge { background: #e74c3c; color: white; font-size: 0.7rem; padding: 3px 6px; border-radius: 4px; vertical-align: middle; }
        
        .instruction { font-size: 0.9rem; color: #666; margin-bottom: 20px; }
        .btn { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 1rem; transition: background 0.2s; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn:hover:not(:disabled) { background: #219150; }

        /* Report Cards */
        .report-card { background: white; border-radius: 8px; padding: 15px; margin-top: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 4px solid #ddd; }
        .card-solar { border-left-color: #f1c40f; }
        .card-wind { border-left-color: #3498db; }
        .card-conservation { border-left-color: #27ae60; }
        
        .metric-title { font-weight: bold; font-size: 0.85rem; text-transform: uppercase; color: #7f8c8d; }
        .metric-value { font-size: 1.5rem; font-weight: bold; color: #2c3e50; }
        .metric-unit { font-size: 0.9rem; color: #7f8c8d; }
        
        /* Premium Upsell Section */
        .premium-header { margin-top: 25px; padding-top: 15px; border-top: 2px dashed #ccc; font-weight: bold; color: #2c3e50; font-size: 1.1rem; }
        .premium-desc { font-size: 0.85rem; color: #666; margin-bottom: 15px; }
        .premium-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .premium-box { 
            background: #ecf0f1; 
            border: 1px solid #bdc3c7; 
            padding: 10px 5px; 
            border-radius: 5px; 
            text-align: center; 
            font-size: 0.75rem; 
            color: #2c3e50; 
            text-decoration: none; 
            transition: all 0.2s; 
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .premium-box:hover { background: #2c3e50; color: white; border-color: #2c3e50; }
        
        .loading { text-align: center; color: #666; display: none; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h1><span class="brand">AgriTerra</span> Scout <span class="badge">OHIO</span></h1>
        <p class="instruction">
            1. Use the toolbar on the left to <strong>draw a shape</strong> around an Ohio parcel.<br>
            2. Click "Generate Report" to evaluate the land.
        </p>
        
        <button id="analyzeBtn" class="btn" disabled>Generate Report</button>
        
        <div id="loading" class="loading">
            Analyzing Ohio parcel...<br>
            <small>(Querying datasets)</small>
        </div>

        <div id="results"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <script>
        // 1. Initialize Map (Locked to Ohio with Satellite Toggle)
        var ohioBounds = [[38.401, -84.820], [41.977, -80.518]];
        
        var streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
            attribution: '&copy; OpenStreetMap' 
        });

        var satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        var map = L.map('map', { 
            center: [40.417, -82.907], 
            zoom: 7, 
            minZoom: 7, 
            maxBounds: ohioBounds, 
            maxBoundsViscosity: 1.0,
            layers: [streetMap]
        });

        // Add layer control toggle
        L.control.layers({
            "Street Map": streetMap,
            "Satellite View": satelliteMap
        }).addTo(map);

        // Fetch Ohio County Lines
        fetch('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json')
            .then(r => r.json())
            .then(data => {
                const ohioCounties = { type: "FeatureCollection", features: data.features.filter(f => f.id && f.id.startsWith("39")) };
                L.geoJSON(ohioCounties, { style: { color: "#34495e", weight: 1.5, opacity: 0.6, dashArray: '4, 4', fillOpacity: 0 }, interactive: false }).addTo(map);
            });

        // 2. Add Drawing Controls
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        var drawControl = new L.Control.Draw({ draw: { polygon: true, marker: false, circle: false, circlemarker: false, polyline: false, rectangle: true }, edit: { featureGroup: drawnItems, remove: true }});
        map.addControl(drawControl);

        let currentLayer = null;
        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.clearLayers();
            currentLayer = e.layer;
            drawnItems.addLayer(currentLayer);
            document.getElementById('analyzeBtn').disabled = false;
            map.fitBounds(currentLayer.getBounds());
        });

        map.on(L.Draw.Event.DELETED, function () {
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('results').innerHTML = '';
            currentLayer = null;
        });

        // 4. Analysis Logic
        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            if (!currentLayer) return;

            const loading = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            
            loading.style.display = 'block';
            resultsDiv.innerHTML = '';
            
            const center = currentLayer.getBounds().getCenter();
            
            if (center.lat < 38.4 || center.lat > 42.0 || center.lng < -84.8 || center.lng > -80.5) {
                loading.style.display = 'none';
                resultsDiv.innerHTML = `<div style="color:red; margin-top:10px;">Error: Parcel must be located within Ohio.</div>`;
                return;
            }

            const geoJson = currentLayer.toGeoJSON();
            const areaSqMeters = turf.area(geoJson);
            const acres = (areaSqMeters * 0.000247105).toFixed(1);

            try {
                // --- API CALL 1: NREL Solar Data ---
                // IMPORTANT: Replace YOUR_API_KEY_HERE with your actual key!
                const solarUrl = `https://developer.nrel.gov/api/pvwatts/v8.json?api_key=PLVvOusL7wjyAy2ZMcd0MFroNaL8sGI3hguxkHkm&lat=${center.lat}&lon=${center.lng}&system_capacity=4&azimuth=180&tilt=20&array_type=1&module_type=0&losses=14`;
                const solarResponse = await fetch(solarUrl);
                const solarData = await solarResponse.json();
                const solarOutput = solarData.outputs ? Math.round(solarData.outputs.ac_annual) : "N/A";
                const solarValue = solarOutput !== "N/A" ? `$${Math.round(solarOutput * 0.14)}` : "N/A"; 

                // --- OHIO MOCK CALL: Wind Potential ---
                let windScore = "Moderate";
                if (center.lat > 41.2) windScore = "High (Lake Erie proximity)";
                else if (center.lat < 39.5) windScore = "Low (Southern Topography)";

                // --- OHIO MOCK CALL: CAUV & Conservation ---
                let cauvEst = 0;
                let conservationNotes = "";
                
                if (center.lng < -83.0 && center.lat > 39.5) {
                    cauvEst = Math.round(acres * 1200); 
                    conservationNotes = "High prime farmland overlap. Minimal wetland conflict.";
                } else if (center.lng > -83.0 && center.lat < 40.0) {
                    cauvEst = Math.round(acres * 350); 
                    conservationNotes = "High potential for forest management or CRP.";
                } else {
                    cauvEst = Math.round(acres * 800); 
                    conservationNotes = "Moderate prime farmland. Evaluate riparian buffers.";
                }

                // --- RENDER LIGHT REPORT RESULTS ---
                let html = `
                    <div class="report-card">
                        <div class="metric-title">Selected Ohio Parcel</div>
                        <div class="metric-value">${acres} <span class="metric-unit">Acres</span></div>
                        <div style="font-size:0.8rem; color:#888;">Lat: ${center.lat.toFixed(3)}, Lng: ${center.lng.toFixed(3)}</div>
                    </div>

                    <div class="report-card card-solar">
                        <div class="metric-title">Solar Potential (PVWatts)</div>
                        <div class="metric-value">${solarOutput.toLocaleString()} <span class="metric-unit">kWh/yr</span></div>
                        <p style="font-size: 0.9rem; margin: 5px 0 0 0;">
                            Est. Energy Value: <strong>${solarValue}/yr</strong><br>
                            <small>Based on a standard 4kW test array.</small>
                        </p>
                    </div>

                    <div class="report-card card-wind">
                        <div class="metric-title">Wind Suitability</div>
                        <div class="metric-value">${windScore}</div>
                        <p style="font-size: 0.9rem; margin: 5px 0 0 0;">
                            <small>Based on Ohio regional estimates.</small>
                        </p>
                    </div>

                    <div class="report-card card-conservation">
                        <div class="metric-title">Est. CAUV Value & Conservation</div>
                        <div class="metric-value">$${cauvEst.toLocaleString()}</div>
                        <p style="font-size: 0.9rem; margin: 5px 0 0 0;">
                            <strong>Notes:</strong> ${conservationNotes}
                        </p>
                    </div>
                `;

                // --- RENDER PREMIUM UPSELL SECTION ---
                // Replace the "https://yourwebsite.com/inquiry" links with your actual form URL
                html += `
                    <div class="premium-header">Unlock Deep Analysis</div>
                    <p class="premium-desc">Need more than a quick scan? Request a comprehensive, farmer-ready AgriTerra report for this exact parcel.</p>
                    
                    <div class="premium-grid">
                        <a href="https://yourwebsite.com/inquiry?topic=property" target="_blank" class="premium-box">Property Info</a>
                        <a href="https://yourwebsite.com/inquiry?topic=physical" target="_blank" class="premium-box">Physical Characteristics</a>
                        <a href="https://yourwebsite.com/inquiry?topic=regulatory" target="_blank" class="premium-box">Regulatory Context</a>
                        <a href="https://yourwebsite.com/inquiry?topic=infrastructure" target="_blank" class="premium-box">Infrastructure Proximity</a>
                        <a href="https://yourwebsite.com/inquiry?topic=ag_value" target="_blank" class="premium-box">Agricultural Value</a>
                        <a href="https://yourwebsite.com/inquiry?topic=market" target="_blank" class="premium-box">Market Context</a>
                        <a href="https://yourwebsite.com/inquiry?topic=risks" target="_blank" class="premium-box">Risks & Trade-Offs</a>
                        <a href="https://yourwebsite.com/inquiry?topic=insights" target="_blank" class="premium-box">Plain-Language Insights</a>
                    </div>
                `;
                
                resultsDiv.innerHTML = html;

            } catch (error) {
                console.error(error);
                resultsDiv.innerHTML = `<div style="color:red; margin-top:10px;">Error fetching data. Please try again.</div>`;
            } finally {
                loading.style.display = 'none';
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AgriTerra Land Scout - Ohio Edition</title>
    
    <script src="config.js"></script>

    <script>
        (function() {
            const gaId = window.AGRI_CONFIG?.GA_MEASUREMENT_ID;
            const clarityId = window.AGRI_CONFIG?.CLARITY_ID;
            if (gaId) {
                const s = document.createElement('script'); s.async = true;
                s.src = "https://www.googletagmanager.com/gtag/js?id=" + gaId;
                document.head.appendChild(s);
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date()); gtag('config', gaId);
                window.gtag = gtag;
            }
            if (clarityId) {
                (function(c,l,a,r,i,t,y){
                    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
                    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
                    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
                })(window, document, "clarity", "script", clarityId);
            }
        })();
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <style>
        :root { --brand-green: #27ae60; --dark-slate: #2c3e50; }
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 380px; background: #f8f9fa; padding: 25px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000; overflow-y: auto; display: flex; flex-direction: column; }
        #map { flex-grow: 1; }
        h1 { color: var(--dark-slate); font-size: 1.6rem; margin: 0 0 15px 0; }
        .brand { color: var(--brand-green); font-weight: bold; }
        .badge { background: #e74c3c; color: white; font-size: 0.7rem; padding: 3px 6px; border-radius: 4px; vertical-align: middle; margin-left: 5px; }
        .search-container { display: flex; gap: 8px; margin-bottom: 20px; }
        .search-container input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem; }
        .search-container button { background: var(--dark-slate); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-main { background: var(--brand-green); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 1.1rem; font-weight: bold; }
        .btn-main:disabled { background: #cbd5e0; }
        
        /* Insight Cards */
        .report-card { background: white; border-radius: 10px; padding: 15px; margin-top: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ddd; }
        .card-solar { border-left-color: #f1c40f; }
        .card-wind { border-left-color: #3498db; }
        .card-conservation { border-left-color: var(--brand-green); }
        .metric-title { font-weight: bold; font-size: 0.75rem; text-transform: uppercase; color: #7f8c8d; margin-bottom: 5px; }
        .metric-value { font-size: 1.4rem; font-weight: bold; color: var(--dark-slate); }
        .metric-note { font-size: 0.85rem; color: #666; margin-top: 5px; line-height: 1.3; }

        .premium-header { margin-top: 30px; padding-top: 20px; border-top: 2px dashed #cbd5e0; font-weight: bold; color: var(--dark-slate); }
        .premium-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; margin-bottom: 30px; }
        .premium-box { background: white; border: 1px solid #e2e8f0; padding: 12px 8px; border-radius: 8px; text-align: center; font-size: 0.75rem; color: var(--dark-slate); text-decoration: none; font-weight: bold; transition: background 0.2s; }
        .premium-box:hover { background: var(--dark-slate); color: white; }
        .loading { text-align: center; padding: 20px; display: none; font-style: italic; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h1><span class="brand">AgriTerra</span> Scout <span class="badge">OHIO</span></h1>
        <div class="search-container">
            <input type="text" id="addressInput" placeholder="Find Ohio address..." />
            <button id="searchBtn">Find</button>
        </div>
        <button id="analyzeBtn" class="btn-main" disabled>Generate Report</button>
        <div id="loading" class="loading">Analyzing Ohio datasets...</div>
        <div id="results"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <script>
        var ohioBounds = [[38.401, -84.820], [41.977, -80.518]];
        var satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
        var streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' });

        var map = L.map('map', { center: [40.417, -82.907], zoom: 7, minZoom: 7, maxBounds: ohioBounds, layers: [satelliteMap] });
        L.control.layers({ "Satellite": satelliteMap, "Street": streetMap }).addTo(map);

        document.getElementById('searchBtn').addEventListener('click', async () => {
            const query = document.getElementById('addressInput').value;
            if (!query) return;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Ohio')}`);
            const data = await res.json();
            if (data && data.length > 0) map.flyTo([data[0].lat, data[0].lon], 16);
        });

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        var drawControl = new L.Control.Draw({ draw: { polygon: true, rectangle: true, marker: false, circle: false, circlemarker: false, polyline: false }, edit: { featureGroup: drawnItems, remove: true } });
        map.addControl(drawControl);

        let currentLayer = null;
        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.clearLayers();
            currentLayer = e.layer;
            drawnItems.addLayer(currentLayer);
            document.getElementById('analyzeBtn').disabled = false;
        });

        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            if (!currentLayer) return;
            const resDiv = document.getElementById('results');
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            resDiv.innerHTML = '';
            
            const center = currentLayer.getBounds().getCenter();
            const acres = (turf.area(currentLayer.toGeoJSON()) * 0.000247105).toFixed(1);
            const apiKey = window.AGRI_CONFIG?.NREL_API_KEY || 'DEMO_KEY';

            try {
                // 1. Solar Data
                const solarRes = await fetch(`https://developer.nrel.gov/api/pvwatts/v8.json?api_key=${apiKey}&lat=${center.lat}&lon=${center.lng}&system_capacity=4&azimuth=180&tilt=20&array_type=1&module_type=0&losses=14`);
                const solarData = await solarRes.json();
                const solarOutput = solarData.outputs ? Math.round(solarData.outputs.ac_annual) : "N/A";

                // 2. Wind & Conservation Logic
                let windScore = (center.lat > 41.2) ? "High (Lake Erie proximity)" : (center.lat < 39.5) ? "Low (Southern Topography)" : "Moderate";
                let cauvEst = (center.lng < -83.0 && center.lat > 39.5) ? Math.round(acres * 1200) : (center.lng > -83.0 && center.lat < 40.0) ? Math.round(acres * 350) : Math.round(acres * 800);
                let conservationNotes = (cauvEst > 1000) ? "High prime farmland overlap." : "Moderate prime farmland potential.";

                resDiv.innerHTML = `
                    <div class="report-card">
                        <div class="metric-title">Measured Parcel</div>
                        <div class="metric-value">${acres} Acres</div>
                    </div>
                    
                    <div class="report-card card-solar">
                        <div class="metric-title">Solar Potential</div>
                        <div class="metric-value">${solarOutput.toLocaleString()} <small>kWh/yr</small></div>
                    </div>

                    <div class="report-card card-wind">
                        <div class="metric-title">Wind Suitability</div>
                        <div class="metric-value">${windScore}</div>
                    </div>

                    <div class="report-card card-conservation">
                        <div class="metric-title">Est. CAUV & Conservation</div>
                        <div class="metric-value">$${cauvEst.toLocaleString()}</div>
                        <div class="metric-note"><strong>Notes:</strong> ${conservationNotes}</div>
                    </div>

                    <div class="premium-header">Unlock Deep Analysis</div>
                    <div class="premium-grid">
                        <a href="insights.html?topic=property&acres=${acres}&lat=${center.lat.toFixed(5)}&lng=${center.lng.toFixed(5)}" target="_blank" class="premium-box" onclick="if(window.gtag) gtag('event', 'premium_click', {'topic': 'property'});">Property Information</a>
                        <a href="insights.html?topic=physical&acres=${acres}&lat=${center.lat.toFixed(5)}&lng=${center.lng.toFixed(5)}" target="_blank" class="premium-box" onclick="if(window.gtag) gtag('event', 'premium_click', {'topic': 'physical'});">Physical Characteristics</a>
    
    <a href="insights.html?topic=regulatory&acres=${acres}&lat=${center.lat.toFixed(5)}&lng=${center.lng.toFixed(5)}" target="_blank" class="premium-box" onclick="if(window.gtag) gtag('event', 'premium_click', {'topic': 'regulatory'});">Regulatory Context</a>
    <a href="insights.html?topic=infrastructure&acres=${acres}&lat=${center.lat.toFixed(5)}&lng=${center.lng.toFixed(5)}" target="_blank" class="premium-box" onclick="if(window.gtag) gtag('event', 'premium_click', {'topic': 'infrastructure'});">Infrastructure Proximity</a>
    <a href="insights.html?topic=ag_value&acres=${acres}&lat=${center.lat.toFixed(5)}&lng=${center.lng.toFixed(5)}" target="_blank" class="premium-box" onclick="if(window.gtag) gtag('event', 'premium_click', {'topic': 'ag_value'});">Agricultural Value</a>
    <a href="insights.html?topic=market&acres=${acres}&lat=${center.lat.toFixed(5)}&lng=${center.lng.toFixed(5)}" target="_blank" class="premium-box" onclick="if(window.gtag) gtag('event', 'premium_click', {'topic': 'market'});">Market Context</a>
    <a href="insights.html?topic=risks&acres=${acres}&lat=${center.lat.toFixed(5)}&lng=${center.lng.toFixed(5)}" target="_blank" class="premium-box" onclick="if(window.gtag) gtag('event', 'premium_click', {'topic': 'risks'});">Risks & Trade-Offs</a>
    <a href="insights.html?topic=insights&acres=${acres}&lat=${center.lat.toFixed(5)}&lng=${center.lng.toFixed(5)}" target="_blank" class="premium-box" onclick="if(window.gtag) gtag('event', 'premium_click', {'topic': 'insights'});">Plain-Language Insights</a>
</div>
                `;
            } catch (err) { resDiv.innerHTML = "Error loading datasets."; }
            finally { loading.style.display = 'none'; }
        });
    </script>
</body>
</html>
